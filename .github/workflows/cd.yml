name: LearnFlow CD

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: choice
        options: [staging, production]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/learnflow

jobs:
  # ── Build & Push Images ─────────────────────────────────────────────────────
  build-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - service: frontend
            path: learnflow-frontend
          - service: triage-service
            path: learnflow-app/services/triage-service
          - service: concepts-service
            path: learnflow-app/services/concepts-service
          - service: debug-service
            path: learnflow-app/services/debug-service
          - service: exercise-service
            path: learnflow-app/services/exercise-service
          - service: progress-service
            path: learnflow-app/services/progress-service
          - service: code-review-service
            path: learnflow-app/services/code-review-service
          - service: mcp-server
            path: learnflow-app/services/mcp-server
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.path }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ── Update K8s Manifests ────────────────────────────────────────────────────
  update-manifests:
    name: Update K8s Image Tags
    runs-on: ubuntu-latest
    needs: build-push
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update image tags in K8s manifests
        run: |
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"
          REGISTRY="${{ env.REGISTRY }}"
          OWNER="${{ github.repository_owner }}"

          for svc in triage-service concepts-service debug-service exercise-service progress-service code-review-service mcp-server; do
            MANIFEST="learnflow-app/services/$svc/k8s/deployment.yaml"
            if [ -f "$MANIFEST" ]; then
              sed -i "s|image: learnflow/.*|image: ${REGISTRY}/${OWNER}/learnflow-${svc}:${SHORT_SHA}|g" "$MANIFEST"
            fi
          done

          # Frontend
          FRONTEND_MANIFEST="learnflow-frontend/k8s/deployment.yaml"
          if [ -f "$FRONTEND_MANIFEST" ]; then
            sed -i "s|image: learnflow/frontend.*|image: ${REGISTRY}/${OWNER}/learnflow-frontend:${SHORT_SHA}|g" "$FRONTEND_MANIFEST"
          fi

      - name: Commit and push manifest updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "cd: update image tags to ${{ github.sha }}"
          git push
