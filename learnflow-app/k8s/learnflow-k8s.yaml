# ─────────────────────────────────────────────────────────────────────────────
# LearnFlow – Complete Kubernetes Deployment (Minikube / Local K8s)
# No Dapr required — direct HTTP service communication
#
# Deploy:
#   kubectl apply -f learnflow-k8s.yaml
#   minikube service api-gateway -n learnflow --url
# ─────────────────────────────────────────────────────────────────────────────

# ── Namespace ─────────────────────────────────────────────────────────────────
apiVersion: v1
kind: Namespace
metadata:
  name: learnflow
  labels:
    app.kubernetes.io/name: learnflow
    app.kubernetes.io/part-of: learnflow-platform

---
# ── ConfigMap ─────────────────────────────────────────────────────────────────
apiVersion: v1
kind: ConfigMap
metadata:
  name: learnflow-config
  namespace: learnflow
data:
  AI_MODEL: "llama-3.3-70b-versatile"
  OPENAI_BASE_URL: "https://api.groq.com/openai/v1"
  KAFKA_BROKERS: "kafka:9092"
  DATABASE_URL: "postgresql://admin:admin123@postgres:5432/learnflow"

---
# ── Secret ────────────────────────────────────────────────────────────────────
apiVersion: v1
kind: Secret
metadata:
  name: learnflow-secrets
  namespace: learnflow
type: Opaque
stringData:
  OPENAI_API_KEY: "your-groq-api-key-here"
  GROQ_API_KEY: "your-groq-api-key-here"

---
# ── Kafka (KRaft mode) ────────────────────────────────────────────────────────
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka
  namespace: learnflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kafka
  template:
    metadata:
      labels:
        app: kafka
    spec:
      containers:
      - name: kafka
        image: apache/kafka:3.7.0
        ports:
        - containerPort: 9092
        - containerPort: 9093
        env:
        - name: KAFKA_NODE_ID
          value: "1"
        - name: KAFKA_PROCESS_ROLES
          value: "broker,controller"
        - name: KAFKA_LISTENERS
          value: "PLAINTEXT://:9092,CONTROLLER://:9093"
        - name: KAFKA_ADVERTISED_LISTENERS
          value: "PLAINTEXT://kafka:9092"
        - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP
          value: "PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT"
        - name: KAFKA_CONTROLLER_QUORUM_VOTERS
          value: "1@kafka:9093"
        - name: KAFKA_CONTROLLER_LISTENER_NAMES
          value: "CONTROLLER"
        - name: KAFKA_AUTO_CREATE_TOPICS_ENABLE
          value: "true"
        - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
          value: "1"
        - name: KAFKA_CLUSTER_ID
          value: "MkU3OEVBNTcwNTJENDM2Qk"
        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "500m"
---
apiVersion: v1
kind: Service
metadata:
  name: kafka
  namespace: learnflow
spec:
  selector:
    app: kafka
  ports:
  - name: broker
    port: 9092
    targetPort: 9092

---
# ── PostgreSQL ────────────────────────────────────────────────────────────────
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: learnflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:16-alpine
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_DB
          value: learnflow
        - name: POSTGRES_USER
          value: admin
        - name: POSTGRES_PASSWORD
          value: admin123
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "250m"
        readinessProbe:
          exec:
            command: ["pg_isready", "-U", "admin", "-d", "learnflow"]
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: learnflow
spec:
  selector:
    app: postgres
  ports:
  - port: 5432
    targetPort: 5432

---
# ── Triage Service ────────────────────────────────────────────────────────────
apiVersion: apps/v1
kind: Deployment
metadata:
  name: triage-service
  namespace: learnflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: triage-service
  template:
    metadata:
      labels:
        app: triage-service
    spec:
      containers:
      - name: triage-service
        image: triage-service:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8000
        envFrom:
        - configMapRef:
            name: learnflow-config
        env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: learnflow-secrets
              key: OPENAI_API_KEY
        - name: KNOWLEDGE_BASE_API
          value: "http://concepts-service"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        readinessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 15
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: triage-service
  namespace: learnflow
spec:
  selector:
    app: triage-service
  ports:
  - port: 80
    targetPort: 8000

---
# ── Concepts Service ──────────────────────────────────────────────────────────
apiVersion: apps/v1
kind: Deployment
metadata:
  name: concepts-service
  namespace: learnflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: concepts-service
  template:
    metadata:
      labels:
        app: concepts-service
    spec:
      containers:
      - name: concepts-service
        image: concepts-service:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8001
        envFrom:
        - configMapRef:
            name: learnflow-config
        env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: learnflow-secrets
              key: OPENAI_API_KEY
        - name: PORT
          value: "8001"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        readinessProbe:
          httpGet:
            path: /health
            port: 8001
          initialDelaySeconds: 15
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: concepts-service
  namespace: learnflow
spec:
  selector:
    app: concepts-service
  ports:
  - port: 80
    targetPort: 8001

---
# ── Debug Service ─────────────────────────────────────────────────────────────
apiVersion: apps/v1
kind: Deployment
metadata:
  name: debug-service
  namespace: learnflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: debug-service
  template:
    metadata:
      labels:
        app: debug-service
    spec:
      containers:
      - name: debug-service
        image: debug-service:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8002
        envFrom:
        - configMapRef:
            name: learnflow-config
        env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: learnflow-secrets
              key: OPENAI_API_KEY
        - name: PORT
          value: "8002"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        readinessProbe:
          httpGet:
            path: /health
            port: 8002
          initialDelaySeconds: 15
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: debug-service
  namespace: learnflow
spec:
  selector:
    app: debug-service
  ports:
  - port: 80
    targetPort: 8002

---
# ── Code Review Service ───────────────────────────────────────────────────────
apiVersion: apps/v1
kind: Deployment
metadata:
  name: code-review-service
  namespace: learnflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: code-review-service
  template:
    metadata:
      labels:
        app: code-review-service
    spec:
      containers:
      - name: code-review-service
        image: code-review-service:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8003
        envFrom:
        - configMapRef:
            name: learnflow-config
        env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: learnflow-secrets
              key: OPENAI_API_KEY
        - name: PORT
          value: "8003"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        readinessProbe:
          httpGet:
            path: /health
            port: 8003
          initialDelaySeconds: 15
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: code-review-service
  namespace: learnflow
spec:
  selector:
    app: code-review-service
  ports:
  - port: 80
    targetPort: 8003

---
# ── Exercise Service ──────────────────────────────────────────────────────────
apiVersion: apps/v1
kind: Deployment
metadata:
  name: exercise-service
  namespace: learnflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: exercise-service
  template:
    metadata:
      labels:
        app: exercise-service
    spec:
      containers:
      - name: exercise-service
        image: exercise-service:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8004
        envFrom:
        - configMapRef:
            name: learnflow-config
        env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: learnflow-secrets
              key: OPENAI_API_KEY
        - name: PORT
          value: "8004"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        readinessProbe:
          httpGet:
            path: /health
            port: 8004
          initialDelaySeconds: 15
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: exercise-service
  namespace: learnflow
spec:
  selector:
    app: exercise-service
  ports:
  - port: 80
    targetPort: 8004

---
# ── Progress Service ──────────────────────────────────────────────────────────
apiVersion: apps/v1
kind: Deployment
metadata:
  name: progress-service
  namespace: learnflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: progress-service
  template:
    metadata:
      labels:
        app: progress-service
    spec:
      containers:
      - name: progress-service
        image: progress-service:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8005
        envFrom:
        - configMapRef:
            name: learnflow-config
        env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: learnflow-secrets
              key: OPENAI_API_KEY
        - name: PORT
          value: "8005"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        readinessProbe:
          httpGet:
            path: /health
            port: 8005
          initialDelaySeconds: 20
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: progress-service
  namespace: learnflow
spec:
  selector:
    app: progress-service
  ports:
  - port: 80
    targetPort: 8005

---
# ── MCP Server ────────────────────────────────────────────────────────────────
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mcp-server
  namespace: learnflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mcp-server
  template:
    metadata:
      labels:
        app: mcp-server
    spec:
      containers:
      - name: mcp-server
        image: mcp-server:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8006
        envFrom:
        - configMapRef:
            name: learnflow-config
        env:
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: learnflow-secrets
              key: OPENAI_API_KEY
        - name: PORT
          value: "8006"
        - name: PROGRESS_SERVICE_URL
          value: "http://progress-service"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        readinessProbe:
          httpGet:
            path: /health
            port: 8006
          initialDelaySeconds: 15
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: mcp-server
  namespace: learnflow
spec:
  selector:
    app: mcp-server
  ports:
  - port: 80
    targetPort: 8006

---
# ── API Gateway ───────────────────────────────────────────────────────────────
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: learnflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
      - name: api-gateway
        image: api-gateway:latest
        imagePullPolicy: Never
        ports:
        - containerPort: 8007
        env:
        - name: TRIAGE_SERVICE_URL
          value: "http://triage-service"
        - name: CONCEPTS_SERVICE_URL
          value: "http://concepts-service"
        - name: DEBUG_SERVICE_URL
          value: "http://debug-service"
        - name: REVIEW_SERVICE_URL
          value: "http://code-review-service"
        - name: EXERCISE_SERVICE_URL
          value: "http://exercise-service"
        - name: PROGRESS_SERVICE_URL
          value: "http://progress-service"
        - name: MCP_SERVICE_URL
          value: "http://mcp-server"
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        readinessProbe:
          httpGet:
            path: /health
            port: 8007
          initialDelaySeconds: 15
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: learnflow
  labels:
    app: api-gateway
spec:
  selector:
    app: api-gateway
  ports:
  - port: 80
    targetPort: 8007
    nodePort: 30007
  type: NodePort
